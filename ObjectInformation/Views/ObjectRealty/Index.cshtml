@using System.Security.Policy
@using ObjectInformation.DAL.Model
@model List<ObjectInformation.DAL.Model.ObjectRealty>

@{
    ViewBag.Title = "Объекты";
}
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<style type="text/css">
    .translatedDataTableRow {
        cursor: pointer;
        -webkit-transition-property: background-color;
        -webkit-transition-duration: 0.8451s;
        -webkit-transition-timing-function: ease-out;
    }
</style>

<!-- BEGIN PAGE BAR -->
<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <i class="fa fa-home"></i>
            <a href="@Url.Action("Index", "Home")">Главная</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <a href="#">Управление</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <span style="color:black">Объекты</span>
        </li>
    </ul>
</div>
<!-- END PAGE BAR -->
<!-- BEGIN PAGE TITLE-->
<h1 class="page-title">
    Объекты
    <small>список объектов недвиджимости</small>
</h1>
<!-- END PAGE TITLE-->

<hr />
<a class="btn btn-primary" style="margin-top: 10px;" href="@Url.Action("AddObject", "ObjectRealty")">Добавить объект</a>

<table class="table table-striped table-bordered table-advance table-hover" style="margin-top:20px">
    <thead>
        <tr role="row">
            <th>#</th>
            <th>Тип</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Цена</th>
            <th>Дата приобретения</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Count; i++)
        {
            <tr class="odd parent">
                <td>@(i + 1)</td>
                <td>@Model[i].ObjectType.ObjectTypeName</td>
                <td>@Model[i].Name</td>
                <td>
                    @Model[i].Description<br />
                    <span class="badge badge-default">Адрес:</span>&nbsp
                    <span style="font-size: 11px">@Model[i].GetFullAddress()</span>
                </td>
                <td>
                    @Model[i].Cost <span class="badge badge-default">@Model[i].Currency.Name</span>
                </td>
                <td>
                    @string.Format("{0:dd.MM.yyyy}", Model[i].CostDate)
                    @if (Model[i].DateOfSale != null && Model[i].DateOfSale != DateTime.MinValue)
                    {
                        <span class="badge badge-danger">@string.Format("{0:dd.MM.yyyy}", Model[i].DateOfSale)</span>
                    }
                </td>
                <td>
                    <div class="btn-group  btn-group-solid">
                        <button type="button" class="btn blue dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-ellipsis-horizontal"></i> Дейтсвие <i class="fa fa-angle-down"></i>
                        </button>
                        <ul class="dropdown-menu" style="text-align: left">
                            <li><a href="/ObjectRealty/AddObject?objectRealtyId=@Model[i].ObjectRealtyId" class="edit-button">Редактировать</a></li>
                            <li><a href="/Task/Index?objectRealtyId=@Model[i].ObjectRealtyId">Добавить задачу</a></li>
                            <li><a onclick="AppCity.DeleteRow('@Model[i].ObjectRealtyId', this) " class="delete-button">Удалить</a></li>
                        </ul>
                    </div>
                </td>
            </tr>

            <tr class="child">
                <td class="child" colspan="8">
                    <div class="row">
                        <div class="col-md-6">
                            <ul data-dtr-index="4">
                                @if ((List<ObjectProperty>)ViewBag.ObjectProperty != null)
                                {
                                    foreach (var item in ((List<ObjectProperty>)ViewBag.ObjectProperty).Where(w => w.ObjectRealtyId == Model[i].ObjectRealtyId))
                                    {
                                        <li data-dtr-index="3" data-dt-row="4" data-dt-column="3">
                                            <span class="badge badge-default dtr-title">@item.Property.Name</span>
                                            <span class="dtr-data">@item.Value @item.Property.Unit.Name</span>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-inline blog-images">
                                @foreach (var image in ((List<Upload>)ViewBag.Uploads).Where(w => w.DocumentTypeId == 3 && w.ObjectRealtyId == Model[i].ObjectRealtyId))
                                {
                                    <li>
                                        <a class="fancybox-button" data-rel="fancybox-button" title="@Model[i].Name" href="@image.Path">
                                            <img alt="" src="@image.Path">
                                        </a>
                                    </li>
                                }
                            </ul>
                            <br style="clear: both" />
                            <ul class="list-inline blog-images">
                                @foreach (var image in ((List<Upload>)ViewBag.Uploads).Where(w => w.DocumentTypeId != 3 && w.ObjectRealtyId == Model[i].ObjectRealtyId))
                                {
                                    <li>
                                        <a class="fancybox-button" data-rel="fancybox-button" title="@Model[i].Name" href="@image.Path" target="_newTab">
                                            <img alt="" src="~/assets/global/img/file.png">
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>

            <tr class="child">
                <td class="child" colspan="8">
                    <div class="row">
                        <div class="col-md-6">
                            <ul data-dtr-index="4">
                                @if (Model[i].Tasks != null && Model[i].Tasks.Count > 0)
                                {
                                    foreach (var task in Model[i].Tasks)
                                    {
                                        <li data-dtr-index="3" data-dt-row="4" data-dt-column="3" style="margin-bottom: 10px;">
                                            <span class="badge badge-default dtr-title">@String.Format("{0:dd.MM.yyyy}", task.Deadline)</span>
                                            <span class="dtr-data">@task.TaskDescription</span>
                                            @{ 
                                                string color = "blue";
                                                string percent = "0%";
                                                string warning = "";

                                                var startDate = task.CreateDate;
                                                var deadline = task.Deadline.GetValueOrDefault(DateTime.MaxValue);
                                                var total = (deadline - startDate).TotalSeconds;
                                                var percentage = (DateTime.Now - startDate).TotalSeconds * 100 / total;
                                                percent = percentage.ToString() + "%";
                                                if (task.StatusId == 4)
                                                {
                                                    color = "red";
                                                    warning = "Осталось 5 дней";
                                                }
                                                if (task.StatusId == 5)
                                                {
                                                    percent = "100%";
                                                    color = "green";
                                                }
                                            }
                                            <div class="w3-light-grey" style="margin-top: 10px;">
                                                <div class="w3-container w3-@color w3-center" style="width:@percent">@percent</div>
                                            </div><span style="color: @color;">@warning</span>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script src="~/Scripts/Helper.js"></script>
}